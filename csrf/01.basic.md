CSRF (Cross-Site Request Forgery)

CSRF nedir?

CSRF, bir saldırganın kullamıcları yapmak istemedikleri eylemleri gerçekleştirmeyi sağlayan bir güvenlik zafiyetidir. Bu, saldırganın farklı web sitelerinin birbirine müdahale etmesini önlemek için tasarlanmış olan aynı kaynak politakısını atlatmasına olanak tanır.

CSRF nasıl çalışır?

Bu zafiyet saldırısının gerçekleşmesi için 3 şartın olması gerekir.

1- İlgili eylem -> Saldırgan zafiyeti oluşturmak için uygulama içinde bir güvenlik açığı bulmuştur. Bu güvenlik açığı, kullanıcın şifrelerini değiştirmek, eposta adreslerini değiştirmek olabilir

2- Çerez tabanlı oturum ->  İşlemi gerçekleştirmek, bir veya daha fazla HTTP isteği göndermeyi içerir. Uygulama, istekleri yapan kullanıcıyı tanımlamak için yalnızca oturum çerezlerine güvenir. Oturumları izlemek veya kullanıcı isteklerini doğrulamak için başka mekanizma bulunmamaktadır.

3- Öngörülmeyen istek parametreleri yok -> İşlemi gerçekleştiren istekler, saldırganın
belirleyemeyeceği veya tahmin edemeyeceği değerlere sahip herhangi bir parametre içermez. Örneğin, bir kullanıcının şifresini değiştirmesini sağlarken, saldırganın mevcut şifrenin değerinin bilmesi gerekse bile işlev savunmasız değildir.


Bir uygulamanın kullanıcının hesabındaki e-posta adresini değiştirmesini sağlayan bir işlev içerdiğini varsayalım. Kullanıcı bu işlemi gerçekleştirdiğinde, aşağıdaki gibi HTTP isteği yapar. 

```
POST /email/change HTTP/1.1
Host: vulnerable-website.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 30
Cookie: session=yvthwsztyeQkAPzeQ5gHgTvlyxHfsAfE

email=fuck@anormal-user.com
```

Bu, csrf için gerekli koşulları karşlamaktadır.

 ->  Bir kullanıcının e-posta adresinin değiştirilmesi, saldırganlar için ilgi çekici bir durumdur Bu işlemden sonra, saldırgan genellikle parola sıfırlama işlemini tetikleyebilir ve kullanıcının hesabının tam kontrolünü ele geçirebilir.

 -> Uygulama, isteği hangi kullanıcının gönderdiğini belirlemek için oturum çerezi kullanır. Kullanıcı oturumlarını izlemek için başka hiçbir belirteç veya mekanizma bulunmamaktadır. 

 -> Saldırgan, eylemi gerçekleştirmek için gereken istek parametrelerinin değerlerini kolayca belirleyebilir.


Bu koşullar sağlandığında, saldırgan aşağıdaki HTML kodunu içeren bir web sayfası oluşturabilir:

```
<html>
    <body>
        <form action="https://vulnerable-website.com/email/change" method="POST">
            <input type="hidden" name="email" value="pwned@evil-user.net" />
        </form>
        <script>
            document.forms[0].submit();
        </script>
    </body>
</html>
```


Eğer mağdur kullanıcı saldırganın web sayfasına girerse, aşağıdaki olaylar gerçekleşecektir:

-> Saldırganın sayfası, savunmasız web sitesine bir HTTP isteği tetikleyecektir.

-> Kullanıcı, güvenlik açığı bulunan web sitesine giriş yapmışsa, tarayıcısı isteğe otomatik olarak oturum çerezini ekleyecektir ( SameSite çerezleri kullanılmıyorsa).

-> Güvenlik açığı bulunan web sitesi, isteği normal şekilde işleyecek, sanki mağdur kullanıcı tarafından yapılmış gibi değerlendirecek ve e-posta adresini değiştirecektir.


CSRF saldırısının etkisi nedir?

Başarılı bir CSRF saldırısında, saldırgan kurban kullanıcının istemeden bir eylem gerçekleştirmesine neden olur. Örneğin, bu, hesaplarındaki e-posta adresini değiştirmek, şifrelerini değiştirmek veya para transferi yapmak olabilir. Eylemin niteliğine bağlı olarak, saldırgan kullanıcının hesabının tam kontrolünü ele geçirebilir. Eğer ele geçirilen kullanıcının uygulamada ayrıcalıklı bir rolü varsa, saldırgan uygulamanın tüm verilerinin ve işlevselliğinin tam kontrolünü ele geçirebilir.




CSRF saldırısı nasıl oluşturulur?

Siteler arası istek sahteciliği saldırılarının (CSRF) dağıtım mekanizmaları, esasen yansıtmalı XSS ​​saldırılarıyla aynıdır. Tipik olarak, saldırgan kötü amaçlı HTML kodunu kendi kontrolündeki bir web sitesine yerleştirir ve ardından kurbanları bu web sitesini ziyaret etmeye teşvik eder. Bu, kullanıcıya e-posta veya sosyal medya mesajı yoluyla web sitesine bir bağlantı göndererek yapılabilir. Veya saldırı popüler bir web sitesine (örneğin, bir kullanıcı yorumuna) yerleştirilmişse, kullanıcıların web sitesini ziyaret etmesini bekleyebilirler.

Bazı basit CSRF saldırılarının GET yöntemini kullandığını ve savunmasız web sitesindeki tek bir URL ile tamamen bağımsız olabileceğini unutmayın. Bu durumda, saldırganın harici bir site kullanmasına gerek kalmayabilir ve doğrudan savunmasız alan adındaki kötü amaçlı bir URL'yi kurbanlara iletebilir. Yukarıdaki örnekte, e-posta adresini değiştirme isteği GET yöntemiyle gerçekleştirilebiliyorsa, bağımsız bir saldırı şu şekilde görünür:

```
<img src="https://vulnerable-website.com/email/change?email=pwned@evil-user.net">
```


CSRF'ye karşı yaygın savunmalar
Günümüzde, CSRF güvenlik açıklarını başarılı bir şekilde bulmak ve istismar etmek genellikle hedef web sitesi, kurbanın tarayıcısı veya her ikisi tarafından uygulanan CSRF önleme önlemlerini atlatmayı gerektirir. Karşılaşacağınız en yaygın savunmalar şunlardır:

CSRF belirteçleri - CSRF belirteci, sunucu tarafındaki uygulama tarafından oluşturulan ve istemciyle paylaşılan benzersiz, gizli ve tahmin edilemez bir değerdir. Form gönderme gibi hassas bir işlem gerçekleştirmeye çalışırken, istemcinin isteğe doğru CSRF belirtecini eklemesi gerekir. Bu, bir saldırganın kurban adına geçerli bir istek oluşturmasını çok zorlaştırır.

SameSite çerezleri - SameSite, bir web sitesinin çerezlerinin diğer web sitelerinden gelen isteklere ne zaman dahil edileceğini belirleyen bir tarayıcı güvenlik mekanizmasıdır. Hassas işlemleri gerçekleştirmeye yönelik istekler genellikle kimlik doğrulamalı bir oturum çerezi gerektirdiğinden, uygun SameSite kısıtlamaları bir saldırganın bu işlemleri siteler arası tetiklemesini engelleyebilir. 2021'den beri Chrome, LaxSameSite kısıtlamalarını varsayılan olarak uygulamaktadır. Bu önerilen standart olduğundan, diğer büyük tarayıcıların da gelecekte bu davranışı benimsemesini bekliyoruz.

Referer tabanlı doğrulama - Bazı uygulamalar, genellikle isteğin uygulamanın kendi alan adından geldiğini doğrulayarak CSRF saldırılarına karşı savunma sağlamak için HTTP Referer başlığını kullanır. Bu, genellikle CSRF belirteci doğrulamasından daha az etkilidir.

Bu savunma mekanizmalarının her birinin daha ayrıntılı açıklaması ve bunların nasıl aşılabileceği hakkında bilgi edinmek için aşağıdaki materyallere göz atın. Bunlar arasında, gerçekçi ve kasıtlı olarak savunmasız hedefler üzerinde öğrendiklerinizi uygulamanıza olanak tanıyan etkileşimli laboratuvarlar da bulunmaktadır.










